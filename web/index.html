<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>M68k Interpreter</title>
    <meta name="description" content="">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/jquery-linedtextarea.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="page-header">
            <h1>M68k Interpreter Alpha</h1>
        </div>
        <div id="warnings-container" class="alert alert-warning" style="display: none;"></div>
        <div id="errors-container" class="alert alert-danger" style="display: none;">
            <p class="lead">OOPS! Your RISC-V Assembly code ran, but there were errors...</p>
            <div id="errors"></div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <p class="lead">Codice</p>
                <div id="editor"> function lmao(foo) {} </div>
            </div>

            <div class="col-md-6">
                <div id="register-table" class="table-responsive">
                    <table class="table table-hover table-condensed">
                        <thead>
                            <tr>
                                <th>Init Value</th>
                                <th>Register</th>
                                <th>Hex</th>
                            </tr>
                        </thead>
                        <tbody id="registers">
                            <tr>
                                <td><input id="0" class="init-value" type="text" value="0"></td>
                                <td>a0</td>
                                <td>0</td>
                            <tr>
                                <td><input id="1" class="init-value" type="text" value="0"></td>
                                <td>a1</td>
                                <td>0</td>
                            <tr>
                                <td><input id="2" class="init-value" type="text" value="0"></td>
                                <td>a2</td>
                                <td>0</td>
                            <tr>
                                <td><input id="3" class="init-value" type="text" value="0"></td>
                                <td>a3</td>
                                <td>0</td>
                            <tr>
                                <td><input id="4" class="init-value" type="text" value="0"></td>
                                <td>a4</td>
                                <td>0</td>
                            <tr>
                                <td><input id="5" class="init-value" type="text" value="0"></td>
                                <td>a5</td>
                                <td>0</td>
                            <tr>
                                <td><input id="6" class="init-value" type="text" value="0"></td>
                                <td>a6</td>
                                <td>0</td>
                            <tr>
                                <td><input id="7" class="init-value" type="text" value="0"></td>
                                <td>a7</td>
                                <td>0</td>
                            <tr>
                                <td><input id="8" class="init-value" type="text" value="0"></td>
                                <td>d0</td>
                                <td>0</td>
                            <tr>
                                <td><input id="9" class="init-value" type="text" value="0"></td>
                                <td>d1</td>
                                <td>0</td>
                            <tr>
                                <td><input id="10" class="init-value" type="text" value="0"></td>
                                <td>d2</td>
                                <td>0</td>
                            <tr>
                                <td><input id="11" class="init-value" type="text" value="0"></td>
                                <td>d3</td>
                                <td>0</td>
                            <tr>
                                <td><input id="12" class="init-value" type="text" value="0"></td>
                                <td>d4</td>
                                <td>0</td>
                            <tr>
                                <td><input id="13" class="init-value" type="text" value="0"></td>
                                <td>d5</td>
                                <td>0</td>
                            <tr>
                                <td><input id="14" class="init-value" type="text" value="0"></td>
                                <td>d6</td>
                                <td>0</td>
                            <tr>
                                <td><input id="15" class="init-value" type="text" value="0"></td>
                                <td>d7</td>
                                <td>0</td>
                        </tbody>
                    </table>
                    <button id="register-download" class="btn btn-primary btn-lg">Download Registers!</button>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div class="btn-group-justified" role="group" >
                    <div class="btn-group" >
                        <button id="reset" class="btn btn-primary btn-lg" onclick="reset()">Reset</button>
                    </div>
                    <div class="btn-group">
                        <button id="step" class="btn btn-warning btn-lg" onclick="step()">Step</button>
                    </div>
                    <div class="btn-group">
                        <button id="run" class="btn btn-success btn-lg" onclick="go()">Run</button>
                    </div>
                    <div class="btn-group">
                        <input type="number" id="delay" value="0">
                    </div>
                </div>
                <br>
                <div id="last_instruction" class="well align-bottom">L'istruzione più recente verrà mostrata qui!</div>
                <hr>

            </div>
            <div class="col-md-6">
                <h4>Features</h4>
                <ul>
                    <li><em>Reset</em> to load the code, <em>Step</em> one instruction, or <em>Run</em> all instructions
                    </li>
                    <li>Set a breakpoint by clicking on the line number (only for <em>Run</em>)</li>
                    <li>View <a href="#register-table">registers</a> on the right, <a href="#memory-table">memory</a> on
                        the bottom of this page</li>
                </ul>
                <h4>Supported Instructions</h4>
                <ul>
                    <li>Arithmetics: <code>ADD</code>, <code>ADDI</code>, <code>SUB</code></li>
                    <li>Logical:
                        <code>AND</code>,<code>ANDI</code>,<code>OR</code>,<code>ORI</code>,<code> XOR</code>,<code>XORI</code>
                    </li>
                    <li>Sets: <code>SLT</code>, <code>SLTI</code>, <code>SLTU</code>, <code>SLTIU</code></li>
                    <li>Shifts: <code>SRA</code>, <code>SRAI</code>, <code>SRL</code>,
                        <code>SRLI</code><code>SLL</code>, <code>SLLI</code>
                    </li>
                    <li>Memory: <code>LW</code>, <code>SW</code>, <code>LB</code>, <code>SB</code></li>
                    <li>PC: <code>LUI</code>, <code>AUIPC</code></li>
                    <li>Jumps: <code>JAL</code>, <code>JALR</code></li>
                    <li>Branches: <code>BEQ</code>, <code>BNE</code>,<code>BLT</code>, <code>BGE</code>,
                        <code>BLTU</code>, <code>BGEU</code></li>
                </ul>
                <!-- <p>RISC-V Reference: <a href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf">riscv-spec-v2.2.pdf</a></p>-->
            </div>
        </div>


    </div>
    <hr>
    <div class="row">
        <div class="col-md-12">
            <div class="form-inline text-center">
                <div class="form-group">
                    <label for="memory-address">Memory Address</label>
                    <input type="text" id="memory-address" class="form-control" placeholder="0x00000000"
                        value="0x00000000">
                </div>
                <button id="memory-go" class="btn btn-primary">Go</button>
                <button id="memory-download" class="btn btn-primary">Download!</button>
            </div>
            <br>
            <div id="memory-table" class="table-responsive">
                <table class="table table-hover table-condensed">
                    <thead>
                        <tr>
                            <th>Memory Address</th>
                            <th>Decimal</th>
                            <th>Hex</th>
                            <th>Binary</th>
                        </tr>
                    </thead>
                    <tbody id="memory">
                        <tr>
                            <td>0x00000000</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000004</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000008</td>
                            <td>0</td>
                        <tr>
                            <td>0x0000000c</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000010</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000014</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000018</td>
                            <td>0</td>
                        <tr>
                            <td>0x0000001c</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000020</td>
                            <td>0</td>
                        <tr>
                            <td>0x00000024</td>
                            <td>0</td>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>
    <script type="text/javascript" src="js/sprintf.js"></script>
    <script type="text/javascript" src="js/memory.js"></script>
    <script type="text/javascript" src="js/utilities.js"></script>
    <script type="text/javascript" src="js/operations.js"></script>
    <script type="text/javascript" src="js/emulator.js"></script>
    <script src="./ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");
    </script>

    <script type="text/javascript">

        var ended = false;
        var started = false;
        var worker;

        function go() {
            ended = false;
            // Disabling the step button
            document.getElementById('step').setAttribute("disabled","disabled");

            // Retrieving the code
            var code = editor.getValue();
            // Retriving the user desired delay in seconds -> milliseconds
            var delay = parseInt(document.getElementById('delay').value) * 1000;
            console.log("Starting emulation with delay of " + delay + "ms");
            
            worker = new Emulator(code);

            var registers = new Int32Array(16);

            //Initializing and running the loop at the same time
            (function work() {
                // If the program is not ended
                if(!worker.emulationStep()) {
                    // Updating UI
                    UIUpdate(worker);
                    // Delaying the next step if the user put a delay
                    setTimeout(work, delay);
                } else {
                    // Flagging the program as ended and re-enabling step button
                    ended = true;
                    document.getElementById('step').removeAttribute("disabled");
                }
                    
            })();
        }

        function step() {
            if(ended)
                return;

            if(!started) {
                // Retrieving the code
                var code = editor.getValue();
                worker = new Emulator(code);
                var registers = new Int32Array(16);
                started = true;
            }
            if(!worker.emulationStep()) {
                UIUpdate(worker);
            } else {
                UIUpdate(worker);
                ended = true;
                document.getElementById('step').setAttribute("disabled","disabled");
            }
        }

        function reset() {
            ended = false;
            started = false;
            UIReset();
            console.log("Emulation reset");
        }

    </script>
    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>
</body>